<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Change Management Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1b1f24;
      --muted: #6b7280;
      --card: #f5f7fb;
      --border: #e5e7eb;
      --accent: #2563eb;
      --danger: #dc2626;
      --success: #16a34a;
    }
    [data-theme="dark"] {
      --bg: #0f1115;
      --fg: #e5e7eb;
      --muted: #a3a3a3;
      --card: #151821;
      --border: #262b36;
      --accent: #60a5fa;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--bg); z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand h1 { font-size: 18px; margin: 0; }
    .theme-toggle {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer;
      background: var(--card);
    }
    .wrapper { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
    .tab { padding: 10px 14px; border-radius: 8px 8px 0 0; cursor: pointer; background: transparent; border: 1px solid transparent; font-weight: 600; }
    .tab.active { background: var(--bg); border-color: var(--border); border-bottom-color: var(--bg); }
    .hidden { display: none !important; }

    form .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: block; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--fg); }
    textarea { min-height: 80px; resize: vertical; }
    input:invalid, select:invalid { border-color: var(--danger); }
    .actions { display: flex; gap: 10px; margin-top: 12px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; background: var(--bg); color: var(--fg); }
    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-muted { background: var(--card); }
    .status { font-size: 12px; color: var(--muted); margin-top: 8px; min-height: 16px; }

    .table-wrap { max-height: 60vh; overflow: auto; border: 1px solid var(--border); border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
    th { position: sticky; top: 0; background: var(--card); z-index: 1; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: var(--bg); }
    .footer-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; width: min(800px, 95vw); max-height: 80vh; overflow: auto; }
    .modal h3 { margin-top: 0; }
    .modal .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .close-modal { float: right; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><circle cx="12" cy="12" r="10" opacity="0.15"/><path d="M7 12h10M12 7v10" stroke="currentColor" stroke-width="2" fill="none"/></svg>
      <h1>Change Management Portal</h1>
    </div>
    <button id="themeToggle" class="theme-toggle" type="button">Toggle theme</button>
  </header>

  <main class="wrapper">
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="create">Create Change</button>
        <button class="tab" data-tab="all">All Changes</button>
      </div>

      <!-- Tab 1: Create Change -->
      <section id="tab-create">
        <form id="changeForm" autocomplete="off">
          <div class="row">
            <div>
              <label>Change Number (auto)</label>
              <input type="text" id="changeNumber" readonly />
            </div>
            <div>
              <label>Priority</label>
              <select id="priority" required>
                <option value="">Select</option>
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
              </select>
            </div>
            <div>
              <label>Type</label>
              <select id="type" required>
                <option value="">Select</option>
                <option>Normal</option>
                <option>Emergency</option>
              </select>
            </div>
            <div>
              <label>Opened By</label>
              <input type="text" id="openedBy" placeholder="Your name" required />
            </div>
            <div>
              <label>Configuration Item</label>
              <select id="ciSelect" required>
                <option value="">Select CI</option>
              </select>
            </div>
            <div>
              <label>Environment (auto)</label>
              <input type="text" id="environment" readonly />
            </div>
            <div>
              <label>State (auto)</label>
              <input type="text" id="state" value="Drafted" readonly />
            </div>
            <div>
              <label>Planned Start Date</label>
              <input type="datetime-local" id="plannedStart" required />
            </div>
            <div>
              <label>Planned End Date</label>
              <input type="datetime-local" id="plannedEnd" required />
            </div>
            <div>
              <label>Owned By (auto from CI)</label>
              <input type="text" id="ownedBy" readonly />
            </div>
            <div>
              <label>Support Group (auto from CI)</label>
              <input type="text" id="supportGroup" readonly />
            </div>
            <div style="grid-column: 1 / -1;">
              <label>Description</label>
              <textarea id="description" placeholder="Change details..."></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn-primary" type="submit" id="saveBtn">Create Change</button>
            <button class="btn-muted" type="button" id="resetBtn">Reset</button>
          </div>
          <div id="formStatus" class="status"></div>

          <input type="hidden" id="editingId" />
        </form>
      </section>

      <!-- Tab 2: All Changes (view-only) -->
      <section id="tab-all" class="hidden">
        <div class="table-wrap">
          <table id="changesTable">
            <thead>
              <tr>
                <th>Change Number</th>
                <th>Priority</th>
                <th>Type</th>
                <th>Opened By</th>
                <th>Configuration Item</th>
                <th>Environment</th>
                <th>Owned By</th>
                <th>Support Group</th>
                <th>State</th>
                <th>Planned Start</th>
                <th>Planned End</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="changesTableBody"></tbody>
          </table>
        </div>
        <div class="footer-actions">
          <button id="exportCsvBtn">Export CSV</button>
          <button id="refreshBtn">Refresh</button>
        </div>
      </section>
    </div>
  </main>

  <!-- Details modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <button class="close-modal" id="closeModalBtn">Close</button>
      <h3>Change Details</h3>
      <div id="modalContent" class="grid"></div>
    </div>
  </div>

  <script type="module">
    // Firebase
   /// import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  //  import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    //const firebaseConfig = {
    //  apiKey: "AIzaSyB9_BivxcGLoY3HipP_c571pA9Robd0yPE",
     // authDomain: "bits-design-project-6a748.firebaseapp.com",
     // projectId: "bits-design-project-6a748",
     // storageBucket: "bits-design-project-6a748.firebasestorage.app",
     // messagingSenderId: "585653073256",
     // appId: "1:585653073256:web:a7ba483097c8829b3952dd"
   // };

    //const app = initializeApp(firebaseConfig);
   // const db = getFirestore(app);

    // Collections
    const CMDB_COLLECTION = "CMDB_DUMP";
    const CHANGES_COLLECTION = "CHANGES";

    // Theme
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("change_theme") || "light";
    root.setAttribute("data-theme", savedTheme);
    document.getElementById("themeToggle").addEventListener("click", () => {
      const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("change_theme", next);
    });

    // Tabs
    const tabs = document.querySelectorAll(".tab");
    const tabCreate = document.getElementById("tab-create");
    const tabAll = document.getElementById("tab-all");
    tabs.forEach(t => {
      t.addEventListener("click", () => {
        tabs.forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        const key = t.dataset.tab;
        tabCreate.classList.toggle("hidden", key !== "create");
        tabAll.classList.toggle("hidden", key !== "all");
      });
    });

    // State
    let allCIs = [];
    let allChanges = [];

    // Elements
    const ciSelect = document.getElementById("ciSelect");
    const environmentEl = document.getElementById("environment");
    const ownedByEl = document.getElementById("ownedBy");
    const supportGroupEl = document.getElementById("supportGroup");
    const changeNumberEl = document.getElementById("changeNumber");
    const formStatus = document.getElementById("formStatus");

    // Modal elements
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalContent = document.getElementById("modalContent");
    const closeModalBtn = document.getElementById("closeModalBtn");
    closeModalBtn.addEventListener("click", () => (modalBackdrop.style.display = "none"));

    // Helpers
    function escapeHtml(str = "") {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function showStatus(msg) {
      formStatus.textContent = msg;
      setTimeout(() => { if (formStatus.textContent === msg) formStatus.textContent = ""; }, 3000);
    }
    function genChangeNumber() {
      const n = Math.floor(Math.random() * 1_000_0000).toString().padStart(7, "0");
      return `CHG${n}`;
    }
    async function ensureUniqueChangeNumber() {
      for (let i = 0; i < 5; i++) {
        const candidate = genChangeNumber();
        const snap = await getDocs(collection(db, CHANGES_COLLECTION));
        const exists = snap.docs.some(d => (d.data().changeNumber === candidate));
        if (!exists) return candidate;
      }
      const ts = Date.now().toString().slice(-7);
      return `CHG${ts}`;
    }

    // Load CIs
    async function loadCIs() {
      const snap = await getDocs(collection(db, CMDB_COLLECTION));
      allCIs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      ciSelect.innerHTML = `<option value="">Select CI</option>` + allCIs.map(ci =>
        `<option value="${ci.id}">${escapeHtml(ci.ciName || "(unnamed)")}</option>`
      ).join("");
    }
    ciSelect.addEventListener("change", () => {
      const ciId = ciSelect.value;
      const ci = allCIs.find(c => c.id === ciId);
      environmentEl.value = ci?.environment || "";
      ownedByEl.value = ci?.ownedBy || "";
      supportGroupEl.value = ci?.supportGroup || "";
    });

    // Load changes
    async function loadChanges() {
      const snap = await getDocs(collection(db, CHANGES_COLLECTION));
      allChanges = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderChangesTable();
    }
    function renderChangesTable() {
      const tbody = document.getElementById("changesTableBody");
      tbody.innerHTML = "";
      allChanges.forEach(ch => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><button class="btn-muted" data-action="view" data-id="${ch.id}">${escapeHtml(ch.changeNumber)}</button></td>
          <td>${escapeHtml(ch.priority || "")}</td>
          <td>${escapeHtml(ch.type || "")}</td>
          <td>${escapeHtml(ch.openedBy || "")}</td>
          <td>${escapeHtml(ch.ciName || "")}</td>
          <td>${escapeHtml(ch.environment || "")}</td>
          <td>${escapeHtml(ch.ownedBy || "")}</td>
          <td>${escapeHtml(ch.supportGroup || "")}</td>
          <td><span class="pill">${escapeHtml(ch.state || "")}</span></td>
          <td>${escapeHtml(ch.plannedStart || "")}</td>
          <td>${escapeHtml(ch.plannedEnd || "")}</td>
          <td><button class="btn-muted" data-action="view" data-id="${ch.id}">View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Export CSV
    document.getElementById("exportCsvBtn").addEventListener("click", () => {
      const rows = [
        ["Change Number","Priority","Type","Opened By","Configuration Item","Environment","Owned By","Support Group","State","Planned Start","Planned End","Description"],
        ...allChanges.map(ch => [
          ch.changeNumber || "", ch.priority || "", ch.type || "", ch.openedBy || "",
          ch.ciName || "", ch.environment || "", ch.ownedBy || "", ch.supportGroup || "",
          ch.state || "", ch.plannedStart || "", ch.plannedEnd || "", (ch.description || "").replace(/\r?\n/g, " ")
        ])
      ];
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "changes_dump.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Refresh
    document.getElementById("refreshBtn").addEventListener("click", async () => {
      await Promise.all([loadCIs(), loadChanges()]);
      showStatus("Refreshed.");
    });

    // Create Change
    document.getElementById("changeForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const ciId = ciSelect.value;
      if (!ciId) { showStatus("Please select a CI."); return; }
      const ci = allCIs.find(c => c.id === ciId);
      if (!ci) { showStatus("Selected CI not found."); return; }

      const plannedStart = document.getElementById("plannedStart").value;
      const plannedEnd = document.getElementById("plannedEnd").value;
      if (!plannedStart || !plannedEnd) { showStatus("Please provide planned dates."); return; }

      const changeNumber = await ensureUniqueChangeNumber();

      const data = {
        changeNumber,
        priority: document.getElementById("priority").value,
        type: document.getElementById("type").value,
        openedBy: document.getElementById("openedBy").value.trim(),
        ciId: ciId,
        ciName: ci.ciName || "",
        environment: ci.environment || "",
        ownedBy: ci.ownedBy || "",
        supportGroup: ci.supportGroup || "",
        state: "Drafted",
        plannedStart,
        plannedEnd,
        description: document.getElementById("description").value.trim(),
        createdAt: new Date().toISOString(),
        approvedAt: null,
        closedAt: null,
        cancelledAt: null
      };

      try {
        await addDoc(collection(db, CHANGES_COLLECTION), data);
        showStatus(`Change ${changeNumber} created.`);
        await loadChanges();
        document.querySelector('.tab[data-tab="all"]').click();
        document.getElementById("changeForm").reset();
        changeNumberEl.value = "";
      } catch (err) {
        console.error(err);
        showStatus("Failed to create change. Check console for details.");
      }
    });

    // Prefill change number on load
    async function prefillChangeNumber() {
      changeNumberEl.value = await ensureUniqueChangeNumber();
    }
    changeNumberEl.addEventListener("focus", prefillChangeNumber);

    // View modal
    document.getElementById("changesTableBody").addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if (action !== "view") return;
      const ch = allChanges.find(x => x.id === id);
      if (!ch) return;
      const fields = [
        ["Change Number", ch.changeNumber],
        ["Priority", ch.priority],
        ["Type", ch.type],
        ["Opened By", ch.openedBy],
        ["Configuration Item", ch.ciName],
        ["Environment", ch.environment],
        ["Owned By", ch.ownedBy],
        ["Support Group", ch.supportGroup],
        ["State", ch.state],
        ["Planned Start", ch.plannedStart],
        ["Planned End", ch.plannedEnd],
        ["Created At", ch.createdAt],
        ["Approved At", ch.approvedAt || ""],
        ["Closed At", ch.closedAt || ""],
        ["Cancelled At", ch.cancelledAt || ""],
        ["Description", ch.description]
      ];
      document.getElementById("modalContent").innerHTML = fields.map(([k, v]) => `
        <div>
          <label style="font-size:12px;color:var(--muted);">${escapeHtml(k)}</label>
          <div>${escapeHtml(v || "")}</div>
        </div>
      `).join("");
      document.getElementById("modalBackdrop").style.display = "flex";
    });

    // Init
    await loadCIs();
    await loadChanges();
    await prefillChangeNumber();
  </script>
</body>

</html>
