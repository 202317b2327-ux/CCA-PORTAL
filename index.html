<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CMDB Dump</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1b1f24;
      --muted: #6b7280;
      --card: #f5f7fb;
      --border: #e5e7eb;
      --accent: #2563eb;
      --danger: #dc2626;
      --success: #16a34a;
    }
    [data-theme="dark"] {
      --bg: #0f1115;
      --fg: #e5e7eb;
      --muted: #a3a3a3;
      --card: #151821;
      --border: #262b36;
      --accent: #60a5fa;
      --danger: #f87171;
      --success: #34d399;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--bg); z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand h1 { font-size: 18px; margin: 0; }
    .theme-toggle {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer;
      background: var(--card);
    }
    .wrapper { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; padding: 16px;
    }
    .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
    .tab {
      padding: 10px 14px; border-radius: 8px 8px 0 0; cursor: pointer;
      background: transparent; border: 1px solid transparent; font-weight: 600;
    }
    .tab.active {
      background: var(--bg); border-color: var(--border); border-bottom-color: var(--bg);
    }
    .hidden { display: none !important; }

    /* Form */
    form .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: block; }
    input, select {
      width: 100%; padding: 10px; border: 1px solid var(--border);
      border-radius: 8px; background: var(--bg); color: var(--fg);
    }
    input:invalid { border-color: var(--danger); }
    .actions { display: flex; gap: 10px; margin-top: 12px; }
    button {
      padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border);
      cursor: pointer; background: var(--bg); color: var(--fg);
    }
    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
    .btn-muted { background: var(--card); }
    .status { font-size: 12px; color: var(--muted); margin-top: 8px; min-height: 16px; }

    /* Table */
    .table-wrap { max-height: 60vh; overflow: auto; border: 1px solid var(--border); border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
    th { position: sticky; top: 0; background: var(--card); z-index: 1; }
    .ci-actions { display: flex; gap: 8px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: var(--bg); }
    .footer-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><circle cx="12" cy="12" r="10" opacity="0.15"/><path d="M7 12h10M12 7v10" stroke="currentColor" stroke-width="2" fill="none"/></svg>
      <h1>CMDB Dashboard</h1>
    </div>
    <button id="themeToggle" class="theme-toggle" type="button">Toggle theme</button>
     </header>
 <a href="change.html">
   <button>Change Dashboard</button>
 </a>
 <a href="approval.html">
   <button>Approval Dashboard</button>
 </a> 
  
  <main class="wrapper">
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="create">CI Creation</button>
        <button class="tab" data-tab="all">All CIs</button>
      </div>

      <!-- Tab 1: CI Creation -->
      <section id="tab-create">
        <form id="ciForm" autocomplete="off">
          <div class="row">
            <div>
              <label>Configuration Item</label>
              <input type="text" id="ciName" placeholder="Server-001" required />
            </div>
            <div>
              <label>Install Status</label>
              <select id="installStatus" required>
                <option value="">Select</option>
                <option>In Use</option>
                <option>Maintenance</option>
                <option>Retired</option>
              </select>
            </div>
            <div>
              <label>Category</label>
              <select id="category" required>
                <option value="">Select</option>
                <option>Logical</option>
                <option>Physical</option>
              </select>
            </div>
            <div>
              <label>Environment</label>
              <select id="environment" required>
                <option value="">Select</option>
                <option>Production</option>
                <option>Non-Production</option>
                <option>Test</option>
                <option>Development</option>
              </select>
            </div>
            <div>
              <label>Service Class</label>
              <select id="serviceClass" required>
                <option value="">Select</option>
                <option>Light</option>
                <option>Standard</option>
                <option>Advanced</option>
              </select>
            </div>
            <div>
              <label>Location</label>
              <input type="text" id="location" placeholder="DC-1 / Rack 3" />
            </div>
            <div>
              <label>Operating System</label>
              <input type="text" id="os" placeholder="Windows Server 2022" />
            </div>
            <div>
              <label>RAM</label>
              <input type="text" id="ram" inputmode="numeric" pattern="^[0-9]+$" placeholder="64" />
            </div>
            <div>
              <label>Disk</label>
              <input type="text" id="disk" placeholder="2 TB" />
            </div>
            <div>
              <label>CPU Count</label>
              <input type="text" id="cpuCount" inputmode="numeric" pattern="^[0-9]+$" placeholder="8" />
            </div>
            <div>
              <label>CPU Type</label>
              <input type="text" id="cpuType" placeholder="Intel Xeon" />
            </div>
            <div>
              <label>Domain</label>
              <input type="text" id="domain" placeholder="corp.example.com" />
            </div>
            <div>
              <label>Owned By</label>
              <input type="text" id="ownedBy" placeholder="Team Alpha" />
            </div>
            <div>
              <label>Support Group</label>
              <input type="text" id="supportGroup" placeholder="InfraOps" />
            </div>
          </div>

          <div class="actions">
            <button class="btn-primary" type="submit" id="saveBtn">Save CI</button>
            <button class="btn-muted" type="button" id="resetBtn">Reset</button>
          </div>
          <div id="formStatus" class="status"></div>

          <input type="hidden" id="editingId" />
        </form>
      </section>

      <!-- Tab 2: All CIs -->
      <section id="tab-all" class="hidden">
        <div class="table-wrap">
          <table id="ciTable">
            <thead>
              <tr>
                <th>Configuration Item</th>
                <th>Install Status</th>
                <th>Category</th>
                <th>Environment</th>
                <th>Service Class</th>
                <th>Location</th>
                <th>OS</th>
                <th>RAM</th>
                <th>Disk</th>
                <th>CPU Count</th>
                <th>CPU Type</th>
                <th>Domain</th>
                <th>Owned By</th>
                <th>Support Group</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="ciTableBody"></tbody>
          </table>
        </div>
        <div class="footer-actions">
          <button id="exportCsvBtn">Export CSV</button>
          <button id="refreshBtn">Refresh</button>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    // --- Firebase shared module content inline (includes updateDoc) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9_BivxcGLoY3HipP_c571pA9Robd0yPE",
      authDomain: "bits-design-project-6a748.firebaseapp.com",
      projectId: "bits-design-project-6a748",
      storageBucket: "bits-design-project-6a748.firebasestorage.app",
      messagingSenderId: "585653073256",
      appId: "1:585653073256:web:a7ba483097c8829b3952dd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Config ---
    const COLLECTION_NAME = "CMDB_DUMP";

    // --- Theme toggle ---
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("cmdb_theme") || "light";
    root.setAttribute("data-theme", savedTheme);
    document.getElementById("themeToggle").addEventListener("click", () => {
      const current = root.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("cmdb_theme", next);
    });

    // --- Tabs ---
    const tabs = document.querySelectorAll(".tab");
    const tabCreate = document.getElementById("tab-create");
    const tabAll = document.getElementById("tab-all");
    tabs.forEach(t => {
      t.addEventListener("click", () => {
        tabs.forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        const key = t.dataset.tab;
        tabCreate.classList.toggle("hidden", key !== "create");
        tabAll.classList.toggle("hidden", key !== "all");
      });
    });

    // --- State ---
    let allCIs = [];

    // --- Helpers ---
    function getFormData() {
      return {
        ciName: document.getElementById("ciName").value.trim(),
        installStatus: document.getElementById("installStatus").value,
        category: document.getElementById("category").value,
        environment: document.getElementById("environment").value,
        serviceClass: document.getElementById("serviceClass").value,
        location: document.getElementById("location").value.trim(),
        os: document.getElementById("os").value.trim(),
        ram: document.getElementById("ram").value.trim(),
        disk: document.getElementById("disk").value.trim(),
        cpuCount: document.getElementById("cpuCount").value.trim(),
        cpuType: document.getElementById("cpuType").value.trim(),
        domain: document.getElementById("domain").value.trim(),
        ownedBy: document.getElementById("ownedBy").value.trim(),
        supportGroup: document.getElementById("supportGroup").value.trim(),
        updatedAt: new Date().toISOString(),
      };
    }

    function setFormData(ci) {
      document.getElementById("ciName").value = ci.ciName || "";
      document.getElementById("installStatus").value = ci.installStatus || "";
      document.getElementById("category").value = ci.category || "";
      document.getElementById("environment").value = ci.environment || "";
      document.getElementById("serviceClass").value = ci.serviceClass || "";
      document.getElementById("location").value = ci.location || "";
      document.getElementById("os").value = ci.os || "";
      document.getElementById("ram").value = ci.ram || "";
      document.getElementById("disk").value = ci.disk || "";
      document.getElementById("cpuCount").value = ci.cpuCount || "";
      document.getElementById("cpuType").value = ci.cpuType || "";
      document.getElementById("domain").value = ci.domain || "";
      document.getElementById("ownedBy").value = ci.ownedBy || "";
      document.getElementById("supportGroup").value = ci.supportGroup || "";
    }

    function clearForm() {
      document.getElementById("ciForm").reset();
      document.getElementById("editingId").value = "";
      document.getElementById("formStatus").textContent = "";
    }

    function validateNumbers() {
      const ram = document.getElementById("ram");
      const cpuCount = document.getElementById("cpuCount");
      const numRegex = /^[0-9]+$/;
      let ok = true;

      if (ram.value && !numRegex.test(ram.value)) { ok = false; ram.setCustomValidity("Only numbers allowed"); }
      else { ram.setCustomValidity(""); }

      if (cpuCount.value && !numRegex.test(cpuCount.value)) { ok = false; cpuCount.setCustomValidity("Only numbers allowed"); }
      else { cpuCount.setCustomValidity(""); }

      return ok;
    }

    function showStatus(msg) {
      const el = document.getElementById("formStatus");
      el.textContent = msg;
      setTimeout(() => { if (el.textContent === msg) el.textContent = ""; }, 3000);
    }

    function escapeHtml(str = "") {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // --- Fetch and render ---
    async function loadAll() {
      const snap = await getDocs(collection(db, COLLECTION_NAME));
      allCIs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById("ciTableBody");
      tbody.innerHTML = "";
      allCIs.forEach(ci => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(ci.ciName)}</td>
          <td><span class="pill">${escapeHtml(ci.installStatus || "")}</span></td>
          <td>${escapeHtml(ci.category || "")}</td>
          <td>${escapeHtml(ci.environment || "")}</td>
          <td>${escapeHtml(ci.serviceClass || "")}</td>
          <td>${escapeHtml(ci.location || "")}</td>
          <td>${escapeHtml(ci.os || "")}</td>
          <td>${escapeHtml(ci.ram || "")}</td>
          <td>${escapeHtml(ci.disk || "")}</td>
          <td>${escapeHtml(ci.cpuCount || "")}</td>
          <td>${escapeHtml(ci.cpuType || "")}</td>
          <td>${escapeHtml(ci.domain || "")}</td>
          <td>${escapeHtml(ci.ownedBy || "")}</td>
          <td>${escapeHtml(ci.supportGroup || "")}</td>
          <td>
            <div class="ci-actions">
              <button class="btn-muted" data-action="modify" data-id="${ci.id}">Modify</button>
              <button class="btn-danger" data-action="delete" data-id="${ci.id}">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Form submit (create or update) ---
    document.getElementById("ciForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!validateNumbers()) {
        showStatus("Please fix numeric fields.");
        return;
      }

      const data = getFormData();
      const editingId = document.getElementById("editingId").value;

      if (!data.ciName) {
        showStatus("Configuration Item name is required.");
        return;
      }

      try {
        if (editingId) {
          const ref = doc(db, COLLECTION_NAME, editingId);
          await updateDoc(ref, data);
          showStatus("CI updated.");
        } else {
          await addDoc(collection(db, COLLECTION_NAME), data);
          showStatus("CI created.");
        }
        await loadAll();
        // Switch to All CIs tab after save so users can immediately see the entry
        document.querySelector('.tab[data-tab="all"]').click();
        clearForm();
      } catch (err) {
        console.error(err);
        showStatus("Operation failed. Check console for details.");
      }
    });

    // --- Reset ---
    document.getElementById("resetBtn").addEventListener("click", clearForm);

    // --- Table actions: modify/delete ---
    document.getElementById("ciTableBody").addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if (action === "modify") {
        const ci = allCIs.find(x => x.id === id);
        if (!ci) return;
        setFormData(ci);
        document.getElementById("editingId").value = id;
        // Jump to CI Creation tab for editing
        document.querySelector('.tab[data-tab="create"]').click();
        showStatus("Editing CI. Save to apply changes.");
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else if (action === "delete") {
        const ok = confirm("Are you sure? This will delete the CI.");
        if (!ok) return;
        try {
          await deleteDoc(doc(db, COLLECTION_NAME, id));
          showStatus("CI deleted.");
          await loadAll();
        } catch (err) {
          console.error(err);
          showStatus("Delete failed. Check console for details.");
        }
      }
    });

    // --- Refresh ---
    document.getElementById("refreshBtn").addEventListener("click", loadAll);

    // --- Export CSV ---
    document.getElementById("exportCsvBtn").addEventListener("click", () => {
      const rows = [
        [
          "Configuration Item","Install Status","Category","Environment","Service Class",
          "Location","Operating System","RAM","Disk","CPU Count","CPU Type","Domain","Owned By","Support Group"
        ],
        ...allCIs.map(ci => [
          ci.ciName || "", ci.installStatus || "", ci.category || "", ci.environment || "", ci.serviceClass || "",
          ci.location || "", ci.os || "", ci.ram || "", ci.disk || "", ci.cpuCount || "", ci.cpuType || "",
          ci.domain || "", ci.ownedBy || "", ci.supportGroup || ""
        ])
      ];
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cmdb_dump.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // --- Init ---
    loadAll();
  </script>
</body>

</html>

